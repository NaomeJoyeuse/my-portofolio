<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Detail</title>
    <link rel="stylesheet" href="blogstyle.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="utils.js" defer></script>
</head>
<body>
    <div class="container">
        <div class="blog-detail" id="blog-detail"></div>
        <a href="index.html" class="back-button">Back Home</a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token'); // Assuming token is stored in local storage

            async function loadBlogDetails() {
                const blogId = new URLSearchParams(window.location.search).get('id');
                if (!blogId) {
                    console.error('Blog ID not found in URL');
                    return;
                }

                try {
                    const response = await fetch(`https://blogs-backend-backup.onrender.com/api/blogs/${blogId}`);
                    if (!response.ok) throw new Error('Failed to fetch blog details');

                    const blog = await response.json();
                    displayBlogDetails(blog);
                    await fetchComments(blog._id);
                } catch (error) {
                    console.error('Error fetching blog details:', error);
                }
            }

            async function fetchLikesCount(blogId) {
                try {
                    const response = await fetch(`https://blogs-backend-backup.onrender.com/api/blogs/${blogId}/likes`);
                    if (!response.ok) throw new Error('Failed to fetch likes count');

                    const data = await response.json();
                    return data.likeCount;
                } catch (error) {
                    console.error('Error fetching likes count:', error);
                    return 0;
                }
            }

            function displayBlogDetails(blog) {
                const blogDetailElement = document.getElementById('blog-detail');
                const formattedDate = new Date(blog.date).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });

                blogDetailElement.innerHTML = `
                    <h1>${blog.title}</h1>
                    <p><strong>Author:</strong> ${blog.author || 'Unknown'}</p>
                    <p><strong>Date:</strong> ${formattedDate}</p>
                    <img src="${blog.image || '/images/default-image.jpg'}" alt="${blog.title}" class="img-fluid rounded">
                    <p>${blog.content}</p>
                    <div class="interaction">
                        <button class="like-button ${blog.isLiked ? 'liked' : ''}" data-id="${blog._id}">
                            <i class="fas fa-thumbs-up"></i> <span class="like-count">Loading...</span>
                        </button>
                    </div>
                    
                    <div class="comments-section" id="comments-${blog._id}">
        <h3>Comments <span class="comment-count">Loading...</span></h3>
        <ul id="comment-list-${blog._id}"></ul>
        <button class="add-comment-button" id="add-comment-${blog._id}">Add Comment</button>
        <form class="comment-form" id="comment-form-${blog._id}" style="display: none;">
            <textarea placeholder="Add a comment..." required></textarea>
            <button type="submit">Submit</button>
        </form>
    </div>
                `;

                        document.getElementById(`add-comment-${blog._id}`).addEventListener('click', function() {
            const commentForm = document.getElementById(`comment-form-${blog._id}`);
            if (commentForm.style.display === 'none' || commentForm.style.display === '') {
                commentForm.style.display = 'block'; 
            } else {
                commentForm.style.display = 'none'; 
            }
        });
                const likeButton = blogDetailElement.querySelector('.like-button');
                const likeCountElement = blogDetailElement.querySelector('.like-count');

                likeButton.addEventListener('click', async (event) => {
                    event.preventDefault();
                    const postId = likeButton.getAttribute('data-id');

                    try {
                        const likeResponse = await fetch(`https://blogs-backend-backup.onrender.com/api/blogs/${postId}/like`, {
                            method: 'POST',
                            headers: {
                                'Authorization': token
                            }
                        });

                        if (likeResponse.ok) {
                            const result = await likeResponse.json();
                            const currentLikes = parseInt(likeCountElement.textContent);
                            likeCountElement.textContent = result.message === 'Like added' ? currentLikes + 1 : Math.max(0, currentLikes - 1);
                            likeButton.classList.toggle('liked', result.message === 'Like added');
                        } else {
                            console.error('Failed to like blog:', await likeResponse.text());
                        }
                    } catch (error) {
                        console.error('Error liking the blog:', error);
                    }
                });

                fetchLikesCount(blog._id).then(likeCount => {
                    likeCountElement.textContent = likeCount;
                });

                // const commentButton = blogDetailElement.querySelector('.comment-button');
                // commentButton.addEventListener('click', async (event) => {
                //     const postId = commentButton.getAttribute('data-id');
                //     const commentsSection = document.getElementById(`comments-${postId}`);
                //     commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';

                //     if (commentsSection.style.display === 'block') {
                //         await fetchComments(postId, commentButton);
                //     }
                // });

                const commentForm = blogDetailElement.querySelector(`#comment-form-${blog._id}`);
                commentForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const textarea = commentForm.querySelector('textarea');
                    const content = textarea.value;

                    try {
                        const commentResponse = await fetch(`https://blogs-backend-backup.onrender.com/api/blogs/${blog._id}/comments`, {
                            method: 'POST',
                            headers: {
                                'Authorization': token,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ content })
                        });

                        if (commentResponse.ok) {
                            const newComment = await commentResponse.json();
                            addCommentToList(newComment, blog._id);
                            textarea.value = '';
                        } else {
                            console.error('Failed to add comment');
                        }
                    } catch (error) {
                        console.error('Error adding comment:', error);
                    }
                });
            }

            async function fetchComments(blogId) {
            try {
                const commentsResponse = await fetch(`https://blogs-backend-backup.onrender.com/api/blogs/${blogId}/comments`, {
                    method: 'GET',
                    headers: {
                        'Authorization': token
                    }
                });

                if (commentsResponse.ok) {
                    const comments = await commentsResponse.json();
                    const commentList = document.getElementById(`comment-list-${blogId}`);
                    commentList.innerHTML = '';

                    comments.forEach(comment => {
                        
                        addCommentToList(comment, blogId);
                    });

                    document.querySelector('.comment-count').textContent = comments.length;
                } else {
                    console.error('Failed to fetch comments');
                }
            } catch (error) {
                console.error('Error fetching comments:', error);
            }
        }
        function addCommentToList(comment, blogId) {
            const commentList = document.getElementById(`comment-list-${blogId}`);
            const email = comment.user.email; // Get the email
            const username = email.split('@')[0];
            const commentHTML = `
                <li class="mb-2">
                    <div class="comment">
                        <p><strong>${username}</strong>: ${comment.content}</p>
                    </div>
                </li>
            `;
            commentList.innerHTML += commentHTML;
        }

        loadBlogDetails();
        });
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Detail</title>
    <link rel="stylesheet" href="blogstyle.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="utils.js"></script>
</head>
<body>
    <div class="container">
        <div class="blog-detail" id="blog-detail">
        </div>
        <a href="index.html" class="back-button">Back Home</a>
    </div>  
        </div>
     </div>
    

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            async function loadBlogDetails() {
                const blogId = new URLSearchParams(window.location.search).get('id'); // Assuming `id` is passed in the URL
                if (!blogId) {
                    console.error('Blog ID not found in URL');
                    return;
                }
        
                try {
                    const response = await fetch(`https://blogs-backend-backup.onrender.com/api/blogs/${blogId}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch blog details');
                    }
        
                    const blog = await response.json();
                    displayBlogDetails(blog);
                } catch (error) {
                    console.error('Error fetching blog details:', error);
                }
            }
        
            async function fetchLikesCount(blogId) {
                try {
                    const response = await fetch(`https://blogs-backend-backup.onrender.com/api/blogs/${blogId}/likes`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch likes count');
                    }
                    const data = await response.json();
                    return data.likeCount;
                } catch (error) {
                    console.error('Error fetching likes count:', error);
                    return 0; 
                }
            }
        
            function displayBlogDetails(blog) {
                const blogDetailElement = document.getElementById('blog-detail');
                const formattedDate = new Date(blog.date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
        
                blogDetailElement.innerHTML = `
                    <h1>${blog.title}</h1>
                    <p><strong>Author:</strong> ${blog.author || 'Unknown'}</p>
                    <p><strong>Date:</strong> ${formattedDate}</p>
                    <img src="${blog.image || '/images/default-image.jpg'}" alt="${blog.title}" class="img-fluid rounded">
                    <p>${blog.content}</p>
                    <div class="interaction">
                        <button class="like-button ${blog.isLiked ? 'liked' : ''}" data-id="${blog._id}">
                            <i class="fas fa-thumbs-up"></i> <span class="like-count">Loading...</span>
                        </button>
                    </div>
                `;
        
                const likeButton = blogDetailElement.querySelector('.like-button');
                const likeCountElement = blogDetailElement.querySelector('.like-count');
                const likesCountElement = document.getElementById('likes-count');
        
                if (likeButton) {
                    likeButton.addEventListener('click', async (event) => {
                        event.preventDefault();
        
                        const postId = likeButton.getAttribute('data-id');
        
                        try {
                            const likeResponse = await fetchWithToken(`https://blogs-backend-backup.onrender.com/api/blogs/${postId}/like`, {
                                method: 'POST'
                            });
        
                            if (likeResponse.ok) {
                                const result = await likeResponse.json();
                                if (result.message === 'Like added') {
                                    likeCountElement.textContent = parseInt(likeCountElement.textContent) + 1;
                                    likeButton.classList.add('liked');
                                } else if (result.message === 'Like removed') {
                                    likeCountElement.textContent = Math.max(0, parseInt(likeCountElement.textContent) - 1);
                                    likeButton.classList.remove('liked');
                                }
                            } else {
                                const errorText = await likeResponse.text();
                                console.error('Failed to like blog:', errorText);
                            }
                        } catch (error) {
                            console.error('Error liking the blog:', error);
                        }
                    });
                }
        
                // Fetch and display the initial likes count
                fetchLikesCount(blog._id).then(likeCount => {
                    likeCountElement.textContent = likeCount;
                    likesCountElement.textContent = likeCount;
                });
            }
        
            loadBlogDetails();
        });
        </script>
        
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
</body>
</html>
